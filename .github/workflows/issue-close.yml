name: Random issue close

on:
  schedule:
    - cron: "5 10 * * *"   # every day at 10:05 UTC
  workflow_dispatch:

permissions:
  issues: write

jobs:
  issue-close:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ github.repository }}

    steps:
      - name: Close up to 2 random issues with random pattern
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          echo "Looking for up to 2 open issues with 'Random issue' in the title."

          issue_numbers=$(gh issue list \
            --repo "$TARGET_REPO" \
            --state open \
            --limit 50 \
            | awk '/Random issue/ {print $1}' \
            | head -n 2)

          if [[ -z "${issue_numbers}" ]]; then
            echo "No matching open issues found."
            exit 0
          fi

          for num in $issue_numbers; do
            echo "Closing issue #$num"
            gh issue close "$num" \
              --repo "$TARGET_REPO" \
              --comment "Auto-closing random issue."
          done
