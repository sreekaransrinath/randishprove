name: Random bot PR create

on:
  schedule:
    - cron: "10 10 * * *"   # every day at 10:10 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  pr-create-bot:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ github.repository }}
      DEFAULT_BRANCH: main

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Configure git identity as bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create 1â€“3 random bot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # author = github-actions[bot]
        run: |
          set -euo pipefail

          git fetch origin "$DEFAULT_BRANCH"
          git checkout "$DEFAULT_BRANCH"

          MIN=1
          MAX=3
          COUNT=$(( RANDOM % (MAX - MIN + 1) + MIN ))

          echo "Creating $COUNT random bot PR(s) in $TARGET_REPO based on $DEFAULT_BRANCH."

          for ((i=1; i<=COUNT; i++)); do
            TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            BRANCH="auto/bot-pr-$(date -u +%Y%m%d-%H%M%S)-$i-$RANDOM"

            echo "Creating branch $BRANCH"

            git checkout -b "$BRANCH"
            git commit --allow-empty -m "Bot auto-generated empty commit for PR $i at $TS"
            git push origin "$BRANCH"

            echo "Opening bot PR for $BRANCH"

            gh pr create \
              --repo "$TARGET_REPO" \
              --head "$BRANCH" \
              --base "$DEFAULT_BRANCH" \
              --title "Random bot PR $TS #$i" \
              --body "Bot auto-generated PR $i at $TS from workflow run ${GITHUB_RUN_ID:-local}."

            git checkout "$DEFAULT_BRANCH"
          done
